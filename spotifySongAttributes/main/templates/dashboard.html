<!DOCTYPE html>
<html>
<head>
    <title>Spotify Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="playlist-header">
        <h1>Welcome, {{ user['display_name'] }}</h1>
    </div>

    <div class="charts-container">
        <h2>Supergenre Distribution</h2>
        <div class="chart-wrapper">
            <canvas id="supergenreChart"></canvas>
        </div>

        <h4>Your top super genres:</h4>
        <ul class="genre-list" id="supergenre-list">
            {% for genre, count in user['supergenres'].items() %}
            {% if count > 0 %}
            <li class="genre-item">{{ genre }} ({{ (count | float * 100) | round(2) }}%)</li>
            {% endif %}
            {% endfor %}
        </ul>

        <h2>Subgenre Distribution</h2>
        <div class="chart-wrapper">
            <canvas id="subgenreChart"></canvas>
        </div>

        <h4>Your top subgenres:</h4>
        <ul class="genre-list" id="subgenre-list">
            {% set visible_count = 0 %}
            {% for genre, count in user['subgenres'].items() %}
            {% if count > 0 %}
            {% if visible_count < 10 %}
            <li class="genre-item">{{ genre }} ({{ (count | float * 100) | round(2) }}%)</li>
            {% set visible_count = visible_count + 1 %}
            {% else %}
            <li class="genre-item hidden extra-item">{{ genre }} ({{ (count | float * 100) | round(2) }}%)</li>
            {% endif %}
            {% endif %}
            {% endfor %}
        </ul>
        {% if visible_count >= 10 %}
        <div class="show-more-btn" id="showMoreBtn" onclick="toggleGenres()">Show More</div>
        {% endif %}
    </div>

    <div class="action-buttons">
        <button class="back-button" onclick="window.location.href='/'">Back to Home</button>
    </div>

    <script>
        function toggleGenres() {
            const items = document.querySelectorAll('#subgenre-list .extra-item');
            const button = document.getElementById('showMoreBtn');

            if (button.innerText === "Show More") {
                items.forEach(item => item.classList.remove('hidden'));
                button.innerText = "Show Less";
            } else {
                items.forEach(item => item.classList.add('hidden'));
                button.innerText = "Show More";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Extract data for subgenre chart
            const subgenreLabels = [];
            const subgenreValues = [];

            {% for genre, count in user['subgenres'].items() %}
                {% if count > 0 %}
                    subgenreLabels.push("{{ genre }}");
                    subgenreValues.push({{ count | float }});
                {% endif %}
            {% endfor %}

            // Create subgenre chart
            const subCtx = document.getElementById('subgenreChart').getContext('2d');
            new Chart(subCtx, {
                type: 'polarArea',
                data: {
                    labels: subgenreLabels,
                    datasets: [{
                        label: 'Genre Distribution',
                        data: subgenreValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(199, 199, 199, 0.5)',
                            'rgba(83, 102, 255, 0.5)',
                            'rgba(255, 99, 255, 0.5)',
                            'rgba(0, 204, 102, 0.5)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Subgenre Distribution'
                        }
                    }
                }
            });

            // Extract data for supergenre chart
            const supergenreLabels = [];
            const supergenreValues = [];

            {% for genre, count in user['supergenres'].items() %}
                {% if count > 0 %}
                    supergenreLabels.push("{{ genre }}");
                    supergenreValues.push({{ count | float }});
                {% endif %}
            {% endfor %}

            // Create supergenre chart
            const superCtx = document.getElementById('supergenreChart').getContext('2d');
            new Chart(superCtx, {
                type: 'polarArea',
                data: {
                    labels: supergenreLabels,
                    datasets: [{
                        label: 'Genre Distribution',
                        data: supergenreValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(199, 199, 199, 0.5)',
                            'rgba(83, 102, 255, 0.5)',
                            'rgba(255, 99, 255, 0.5)',
                            'rgba(0, 204, 102, 0.5)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Supergenre Distribution'
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>